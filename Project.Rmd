---
title: "TextMiningProject"
output: html_document
---

```{r}
install.packages("request")
install.packages("jsonlite")
install.packages("tidyverse")
require("jsonlite")
require("request")
require("tidyverse")
```


```{r}
require(pdflatex)
require(tinytex)
require(quanteda)
require(quanteda.textmodels)
require(quanteda.textstats)
require(quanteda.textplots)
# devtools::install_github("kbenoit/quanteda.dictionaries") 
require(quanteda.dictionaries)
require(readtext)
require(devtools)
require(quanteda.corpora)
require(newsmap)
require(seededlda)
require(ggplot2)
```

```{r}
subreddit = "worldnews"
timepoint = 1576399066
```



```{r}
base_url = "https://api.pushshift.io/reddit/search/"
submission_endpoint = "submission/"


sort = "desc"
entries = 10
fields=paste("author","created_utc","domain","full_link","num_comments","score","title","id",sep=",")


# so that we get the top posts
sort_type = "score"




getTopPosts = function(){
  query_top_posts = paste(base_url, submission_endpoint,"?",
                        "subreddit=",subreddit,"&",
                        "sort=",sort,"&",
                        "size=",entries,"&",
                        "before=",timepoint,"&",
                        "sort_type=",sort_type,"&",
                        "fields=",fields,
                        sep="")
  q1 = fromJSON(query_top_posts)
  return(as.matrix(q1$data))

}

top_posts = getTopPosts()
```





```{r}
base_url = "https://www.reddit.com/r/"
comment_endpoint = "comments/"
id = "rgu4t3"


sort = "top" #alternative: controversial
entries = 20
depth = 5




getComments = function(comment){
  print(comment)
  df = subset(comment,select = c("id","author","body"))
  
  for (repl in comment[["replies"]]) {
    if(!is.null(repl) && !is.character(repl)){
      
      df = rbind(df, getComments(as.data.frame(repl$data$children[2])$data))
    }
  }
  
  
  return(df)
}


getAllCommentsById = function(id){
  query_comments = paste(base_url,subreddit,"/", comment_endpoint,id,".json?",
                        "depth=",depth,"&",
                        "limit=",entries,"&",
                        "showtitle=false&",
                        "showedits=false&",
                        "showmedia=false&",
                        "showmore=false&",
                        "sort=",sort,
                        sep="")
  commentFromJson = fromJSON(query_comments)
  raw_df = as.data.frame(commentFromJson$data$children[2])$data
  print(raw_df == "raw_df")
  
  df = getComments(comment = raw_df)
  return(df)
}


df_result <- getAllCommentsById(id)
```



```{r}
sources = aggregate(q2$domain,by=list(q2$domain), FUN=length) 
sources = as.data.frame(sources)
sources = filter(sources, x>1)



barplot(height=sources$x,names = sources$Group.1,
        xlab="posts", 
        ylab="news outlets", 
        main="Sources", 
        horiz=T, las=1,
        )
```


